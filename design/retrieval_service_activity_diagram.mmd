# Retrieval Service Activity Diagram

flowchart TD
    %% --- STYLING DEFINITIONS ---
    classDef orchestrator fill:#f5f5f5,stroke:#616161,stroke-width:2px,color:#333;
    classDef ai fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#333;
    classDef logic fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#333;
    classDef data fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,stroke-dasharray: 5 5,color:#333;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#333;

    %% --- ENTRY POINT ---
    Start([Client Request]):::orchestrator --> Input[/Input: user_query, is_llm_generated/]

    %% --- 1. ORCHESTRATOR ---
    subgraph Service [" âš™ï¸ Retrieval Service (Orchestrator) "]
        direction TB
        Input --> CallRouter[Call QueryRouter]:::orchestrator
        CallRepo[Call Repository]:::orchestrator
        CheckFlag{Generate Answer?}:::decision
        FormatRaw[Format JSON Response]:::orchestrator
    end

    %% --- 2. INTENT ---
    subgraph Router [" ðŸ§  Query Router (LLM) "]
        direction TB
        DetectIntent[Analyze Intent / Function Call]:::ai
        SelectTool{Select Tool}:::decision
        ToolLine[Tool: SearchLineItems]:::ai
        ToolInv[Tool: SearchInvoices]:::ai
    end

    %% --- 4. DATA ---
    subgraph Repo [" ðŸ—„ï¸ Infrastructure (IQueryInvoiceRepository) "]
        direction TB
        Mongo[("MongoDB Aggregation")]:::data
    end

    %% --- 5. SYNTHESIS (NEW COMPONENT) ---
    subgraph AnswerGen [" ðŸ“ Answer Generator "]
        direction TB
        Synthesize[Generate Grounded Answer]:::ai
    end

    %% --- FLOW CONNECTIONS ---

    %% Service -> Router
    CallRouter --> DetectIntent
    DetectIntent --> SelectTool
    SelectTool --> |Line Items| ToolLine
    SelectTool --> |Invoices| ToolInv

    %% Router -> Service -> Repo
    ToolLine & ToolInv --> CallRepo
    CallRepo --> Mongo

    %% Repo Results -> Service Decision
    Mongo --> |"Results (Top-k)"| CheckFlag

    %% Decision Branching
    CheckFlag -- No --> FormatRaw
    CheckFlag -- Yes --> Synthesize

    %% Answer Generator Context Inputs
    Input -.-> |"user_query"| Synthesize

    %% Outputs
    Synthesize --> Output1([Return: Grounded Answer]):::orchestrator
    FormatRaw --> Output2([Return: Structured Data]):::orchestrator